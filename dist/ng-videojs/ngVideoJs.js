!function(t,n){var e=n.vjs||n.videojs,o=t.module("ngVideoJs",["ngSanitize"]);!function(t){t.config(["$sceDelegateProvider",function(t){t.resourceUrlWhitelist(["**"])}])}(o),function(t,n){n.factory("stringUtils",function(){return{replaceByIndex:function(t,n,e,o){var i=t.length,a=t.substring(o,i),r=t.substring(0,e-1);return r+n+a}}})}(t,o),function(t,n){var e={keyAndVal:function(t){return t.match(/[ ]*([^ ]*)[ ]*=[ ]*(.*)[ ]*/)},note:function(t){var n=this.keyAndVal(t),e=!1;return n&&n.length>=3&&(e={key:n[1],value:n[2]}),e},rNotSpaceLine:/^.+=.+$/,notes:function(n){var e={},o=this;return t.forEach(n.split("\n"),function(t){if(o.rNotSpaceLine.test(t)){var n=o.note(t);n&&(e[n.key]=n)}}),e},index:function(n){var e,o,i=this.keyAndVal(n),a=null;if(i&&i.length>=3){e=i[1],o=i[2].match(/\[[ ]*\d+[ ]*,[ ]*\d+[ ]*,[^\]]+\]/g);var a={lineNumber:parseInt(e),data:[]};t.forEach(o,function(t){var n=/\[[ ]*(\d+)[ ]*,[ ]*(\d+)[ ]*,[ ]*([^\]]+)[ ]*\]/.exec(t);n.length>=4&&a.data.push({startIndex:parseInt(n[1]),endIndex:parseInt(n[2]),key:n[3]})})}return a},indexes:function(n,e){var o={},i=this;return t.forEach(n.split("\n"),function(n){if(i.rNotSpaceLine.test(n)){var a=i.index(n);o[a.lineNumber]=a,e&&(t.forEach(a.data,function(t){t.data=e[t.key]}),a.data.sort(function(t,n){return t.endIndex>n.endIndex}))}}),o}};n.factory("properNoun",["$http","$q",function(t,n){return{load:function(o,i){var a=n.defer();return n.all([t.get(o),t.get(i)]).then(function(t){var n=e.notes(t[0].data),o=e.indexes(t[1].data,n);a.resolve(o)},function(){a.reject()}),a.promise}}}])}(t,o),function(t,e){e.factory("srt",["$http","$q",function(e,o){var i=function(t){var n=t.split(/[:,]/),e=36e5*Number(n[0]),o=6e4*Number(n[1]),i=1e3*Number(n[2])+Number(n[3]);return e+o+i},a=function(t){var n=t.split(/\ +-->\ +/),e=i(n[0]),o=i(n[1]);if(e>o){var a=o;o=e,e=a}return{startTime:e,endTime:o}},r=function(n){for(var e=[],o=[],i=0;i<n.length;i++){var r=n[i].split("\n"),s=t.extend({data:r[1],index:Number(i)},a(r[0]));/\[[^\]]+\]/g.test(r)&&o.push(s),s.parentId=o.length,e.push(s)}return{data:e,titles:o}},s=function(t,n){for(var e=0,o=t.length-1;o>=e;){var i;if(i=t[o].startTime-t[e].startTime!=0?parseInt((o-e)*(n-t[e].startTime)/(t[o].startTime-t[e].startTime))+e:e,e>i||i>o)break;if(n>=t[i].startTime&&n<=t[i].endTime)return i;n<t[i].startTime?o=i-1:n>t[i].startTime&&(e=i+1)}return-1};return{createJsonpFun_:function(t,e){for(var o=t.split("."),i=n,a=0;a<o.length;a++)o.length-1<=a?!function(t){i[t]=function(){for(var n=[],o=0;o<arguments.length;o++)n.push(arguments[o]);e&&e(n),delete i[t]}}(o[a]):(i[o[a]]=i[o[a]]?i[o[a]]:{},i=i[o[a]])},get:function(t,n){var i,a=this;if(n){var s=o.defer();i=s.promise,a.createJsonpFun_(n,function(t){s.resolve(t)}),$.getScript(t+"?callback="+n).fail(function(){s.reject()})}else i=e.get(t);var c=o.defer();return i.then(function(t){t=$.isArray(t)?t[0].join("\n"):t.data;var n=t.replace(/\r/g,""),e=n.split(/\n\d+\n/);e.length&&(e[0]=e[0].replace(/^\d+\n/,""));var o=r(e);c.resolve(o)},function(){c.reject("")}),c.promise},findOne:function(t,n){var e=s(t,n);return 0>e?null:t[e]}}}])}(t,o),function(t,n){n.directive("ngCaption",function(){return{scope:{caption:"=ngCaption",current:"=current",onLineClick:"&"},template:['<table><tr  ng-repeat="line in caption" ng-click="onLineClick()"><td class="first"><i class="glyphicon glyphicon-play-circle"></i></td><td><span ng-bind-html="line.data"></span></td></tr></table>'].join(""),link:function(t,n){var e=$(n);t.$watch("ready",function(){t.$watch("current",function(t,o){var i=n.find("tr");if(o&&i.eq(o.index).removeClass("active"),t){var a=i.eq(t.index).addClass("active"),r=$(a).offset().top-e.offset().top-30;e.scrollTop(r+e.scrollTop())}});t.$watch("$destroy",function(){})})}}})}(t,o),function(t,n){n.directive("ngProperNoun",function(){var t=$('<div class="tip-window"></div>'),n=$('<button type="button" class="close" aria-hidden="true">&times;</button>'),e=$("<h4></h4>"),o=$("<div></div>");return t.append(n).append(e).append(o),t.on("click",".close",function(){t.detach()}).on("click",function(t){t.stopPropagation()}),{link:function(n,i){var a,r=$(i);r.on("click",".proper-noun",function(n){n.preventDefault();var i=$(this);a&&a.removeClass("active"),a=i,i.addClass("active"),e.html(i.text()),o.html(i.attr("alt"));var r,s=i.offset();i.parent().hasClass("video-caption")?(t.appendTo(i.parent().parent()),r=s.top-i.height()-t.height()-10):(t.appendTo(document.body),r=s.top+i.height()),t.offset({top:r,left:s.left-t.width()/2})}),r.on("click",function(n){n.target&&!$(n.target).hasClass("proper-noun")&&(t.detach(),a&&(a.removeClass("active"),a=null))})}}})}(t,o),function(t,n){n.factory("VideoCaption",function(){return videojs.VideoCaption=videojs.Component.extend({init:function(t,n,o){e.Component.prototype.init.call(this,t,n,o);var i=this.$content=$("<div class='video-caption'></div>");t.on("fullscreenchange",function(){this.isFullScreen()?i.css("font-size","xx-large"):i.css("font-size","medium")}),i.css({"text-align":"center",bottom:"36px",position:"absolute",color:"white","font-size":"large",left:"0px",right:"0px"}),$(this.el()).css({position:"absolute",left:"0px",right:"0px",bottom:"0px"}),i.appendTo(this.el())},setContent:function(t){t!=this.lastContent_&&(this.$content.html(t),this.lastContent_=t)}})})}(t,o),function(t,n){var o=function(t,n,e){n.on("click",function(){t.clickedLastChapter=e,t.trigger("clickChapter")})},i=function(t,n){t.css({left:n+"%",cursor:"pointer",width:"12px",borderRadius:"5px",bottom:"0px",background:"white",position:"absolute",height:"8px",border:"1px solid black"})},a=function(){var t=$($.parseHTML("<div></div>"));return t.css({position:"absolute",bottom:"20px",width:"100px",left:"-50px","text-align":"center",color:"white",background:"black",padding:"5px","border-radius":"4px"}),t};n.factory("ChapterProgress",function(){return videojs.ChapterProgress=videojs.Component.extend({init:function(t,n,o){e.Component.prototype.init.call(this,t,n,o);var i=a();$(this.el()).on("mouseover","div.chapter-hover",function(){i.html($(this).attr("alt")),i.appendTo($(this))}).on("mouseout","div.chapter-hover",function(){i.detach()}).css({position:"absolute",left:"0px",right:"18px"})},addChapters:function(t){this.chapters_=t},refresh:function(){var t=this.chapters_,n=this.player();if($(this.el()).empty(),t)for(var e=0;e<t.length;e++){var a=$($.parseHTML("<div class='chapter-hover'></div>")),r=t[e],s=r.startTime/1e3/n.duration()*100;a.attr("alt",r.data),i(a,s),this.el().appendChild(a.get(0)),o(this,a,r)}}})})}(t,o),function(t,n){n.factory("ControlBarCaptionBtn",function(){return videojs.ControlBarCaptionBtn=videojs.Component.extend({init:function(t,n,o){e.Component.prototype.init.call(this,t,n,o),this.el().id="abc",$(this.el()).on("click",function(){}).addClass("vjs-captions-button").addClass("vjs-menu-button").addClass("vjs-control ")},focus:function(){var t=$(this.el());t.css("opacity","1"),this.hasFocus_=!0},hasFocus_:!0,hasFocus:function(){return this.hasFocus_},unfocus:function(){var t=$(this.el());t.css("opacity","0.3"),this.hasFocus_=!1}})})}(t,o),function(t,n){n.directive("ngVideoJs",["$timeout","srt","ControlBarCaptionBtn","ChapterProgress","VideoCaption","properNoun","stringUtils","$q",function(n,e,o,i,a,r,s,c){return{template:['<video id="example_video_1" class="video-js vjs-default-skin" controls preload="auto" width="100%" height="100%" poster="{{poster}}" >',"</video>"].join(""),scope:{autoplay:"@",sources:"=",tracks:"=",caption:"=?",currentLine:"=?",timeRate:"=?",showTextTrackDisplay:"=?",showCaptionBtn:"=",noteSrc:"=noteSrc",onFullScreen:"&",onCancelFullScreen:"&",onCaptionButtonClicked:"&",onPlay:"&",onFirstPlay:"&",onTimeupdate:"&",onEnded:"&",onTrackLoaded:"&",onTrackFail:"&",onChapterProgressClicked:"&",jsonp:"@",poster:"=",setFns:"&"},link:function(o,i){var a,l,u,d,p,f,h,v=!1,m={timeupdate:function(){if(a){var t=e.findOne(a.data,1e3*l.currentTime());o.currentLine=t}o.currentLine?t&&f.setContent(t.data):f.setContent(""),o.timeRate=(l.currentTime()/l.duration()*100).toFixed(2),o.onTimeupdate(),"$apply"!=o.$root.$$phase&&"$digest"!=o.$root.$$phase&&o.$apply()},ended:function(){f.setContent(""),o.currentLine=null,o.onEnded(),o.$apply()},firstplay:function(){n(function(){u&&u.refresh()},200),o.onFirstPlay()},fullscreenchange:function(){t.isFunction(o.onFullScreen)&&l.isFullScreen()?o.onFullScreen():t.isFunction(o.onCancelFullScreen)&&!l.isFullScreen()&&o.onCancelFullScreen(),o.$apply()},loadedmetadata:function(){n(function(){u&&u.refresh()},200)},play:function(){o.onPlay(),o.$apply()}};o.$on("$destroy",function(){l&&l.dispose()}),o.$watch("sources",function(g){if(g){"undefined"==typeof o.showTextTrackDisplay&&(o.showTextTrackDisplay=!0);var y=$(i.find("video"));y.find("source").remove(),o.autoplay&&y.prop("autoplay",!0);for(var C in o.sources){var x=document.createElement("source");x.type=o.sources[C].type,x.src=o.sources[C].src,y.append(x)}n(function(){l?y.get(0).load():l=videojs(i.find("video").attr("id")),p=l.getChild("textTrackDisplay"),d=l.getChild("controlBar"),u=d.addChild("ChapterProgress"),f=p.addChild("VideoCaption");var g=d.addChild("ControlBarCaptionBtn");if(g.on("click",function(){this.hasFocus()?this.unfocus():this.focus(),o.onCaptionButtonClicked({showTextTrackDisplay:o.showTextTrackDisplay}),o.$apply()}),o.tracks&&o.tracks.length){var C=[e.get(o.tracks[0].src,o.jsonp)];o.noteSrc&&C.push(r.load(o.noteSrc.note,o.noteSrc.index)),c.all(C).then(function(n){var e=n[0];if(o.caption=a=e,u.addChapters(e.titles),n.length>1){var i=n[1];t.forEach(e.data,function(t,n){var e=n+1;if(i[e])for(var o=i[e].data,a=o.length-1;a>=0;a--){var r=$("<div></div>").text(o[a].data.value).html(),c="<span href='' style='position:relative;' class='proper-noun' alt='"+r+"'>"+t.data.substring(o[a].startIndex-1,o[a].endIndex)+"</span>";t.data=s.replaceByIndex(t.data,c,o[a].startIndex,o[a].endIndex)}})}"$apply"!=o.$root.$$phase&&"$digest"!=o.$root.$$phase&&o.$apply(),o.onTrackLoaded({caption:a})},function(){o.onTrackFail()})}var x=function(t){if(!v)return l.play(),void(h=t);var n=/(ipad)|(android)/i.test(navigator.userAgent)?t.startTime/1e3+.01:t.startTime/1e3;l.currentTime(n.toFixed(1)),o.timeRate=(l.currentTime()/l.duration()*100).toFixed(2);var e="";t&&(e=t.data),f.setContent(e)};u.on("clickChapter",function(){x(this.clickedLastChapter),o.onChapterProgressClicked(),"$apply"!=o.$root.$$phase&&"$digest"!=o.$root.$$phase&&o.$apply()}),o.$watch("showCaptionBtn",function(t){t?g.show():g.hide()}),o.$watch("showTextTrackDisplay",function(t){t?p.show():p.hide()}),l.on("timeupdate",m.timeupdate),l.on("firstplay",m.firstplay),l.on("loadedmetadata",m.loadedmetadata),l.on("fullscreenchange",m.fullscreenchange),l.on("ended",m.ended),l.on("play",m.play),l.on("firstplay",function(){v=!0,h&&(document.createElement("video").canPlayType?(x(h),h=null):n(function(){x(h),h=null},1e3))}),l.dimensions("100%","100%"),$(i).find(".vjs-menu-item").eq(2).trigger("click"),o.setFns({fns:{moveTo:x,currentTime:function(){return l.currentTime()},duration:function(){return l.duration()}}})},200)}})}}}])}(t,o),"undefined"!=typeof module&&(module.exports="ngVideoJs")}(angular,window);